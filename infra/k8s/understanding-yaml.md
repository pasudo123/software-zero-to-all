# k8s yaml ì‘ì„± ì´í•´í•˜ê¸°

## ğŸŸ  ì´ë¯¸ì§€
ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼ ëª¨ë“  ì†Œí”„íŠ¸ì›¨ì–´ ì˜ì¡´ì„±ì„ ìº¡ìŠí™”í•˜ëŠ” ë°”ì´ë„ˆë¦¬ ë°ì´í„°ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.    
ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ëŠ” ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆê³  ëŸ°íƒ€ì„ í™˜ê²½ì— ëŒ€í•´ ì˜ ì •ì˜ëœ ê°€ì •ì„ ë§Œë“œëŠ” ì‹¤í–‰ ê°€ëŠ¥í•œ ì†Œí”„íŠ¸ì›¨ì–´ ë²ˆë“¤ì´ë‹¤.   
ì¼ë°˜ì ìœ¼ë¡œ íŒŒë“œì—ì„œ ì°¸ì¡°í•˜ê¸° ì „ì— ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•´ì„œ ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¡œ í‘¸ì‹œí•œë‹¤.

### ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
ë””í”Œë¡œì´ë¨¼íŠ¸, ìŠ¤í…Œì´íŠ¸í’€ì…‹, íŒŒë“œ ë˜ëŠ” íŒŒë“œ í…œí”Œë¦¿ì€ í¬í•¨í•˜ëŠ” ë‹¤ë¥¸ ì˜¤ë¸Œì íŠ¸ë¥¼ ì²˜ìŒ ë§Œë“¤ ë•Œ,    
íŠ¹ë³„íˆ ëª…ì‹œí•˜ì§€ ì•Šì€ ê²½ìš° ê¸°ë³¸ì ìœ¼ë¡œ í•´ë‹¹ íŒŒë“œì— ìˆëŠ” ëª¨ë“  ì»¨í…Œì´ë„ˆì˜ í’€(pull) ì •ì±…ì€ `IfNotPresent` ë¡œ ì„¤ì •ëœë‹¤.
   
`ì´ë¯¸ì§€ì˜ ê°•ì œ í’€ì„ ì›í•œë‹¤ë©´,`
  * ì»¨í…Œì´ë„ˆì˜ `imagePullPolicy` ë¥¼ `Always` ë¡œ ì„¤ì •

## ğŸŸ  íŒŒë“œ ì»¨í…Œì´ë„ˆì˜ ë¦¬ì†ŒìŠ¤ ìš”ì²­ ì œí•œ
íŒŒë“œì˜ ê° ì»¨í…Œì´ë„ˆëŠ” ë‹¤ìŒ ì¤‘ í•˜ë‚˜ ì´ìƒì„ ì§€ì •í•  ìˆ˜ ìˆë‹¤.

* spec.containers[].resources.requests.cpu
* spec.containers[].resources.requests.memory
* ... (ê·¸ ì™¸)

ìš”ì²­ê³¼ ì œí•œì€ ê°œë³„ ì»¨í…Œì´ë„ˆì—ì„œë§Œ ì§€ì •í•  ìˆ˜ ìˆì§€ë§Œ, íŒŒë“œ ë¦¬ì†ŒìŠ¤ ìš”ì²­ ë° ì œí•œì— ëŒ€í•´ ì´ì•¼ê¸°í•˜ëŠ” ê²ƒì´ í¸ë¦¬í•˜ë‹¤.   
íŠ¹ì • ë¦¬ì†ŒìŠ¤ íƒ€ì…ì— ëŒ€í•œ íŒŒë“œ ë¦¬ì†ŒìŠ¤ ìš”ì²­/ì œí•œì€ íŒŒë“œì˜ ê° ì»¨í…Œì´ë„ˆì— ëŒ€í•œ í•´ë‹¹ íƒ€ì…ì˜ ë¦¬ì†ŒìŠ¤ ìš”ì²­/ì œí•œì˜ í•©ì´ë‹¤.

### ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ ë¦¬ì†ŒìŠ¤ ë‹¨ìœ„
#### CPU ì˜ë¯¸
* CPU ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ì œí•œ ë° ìš”ì²­ì€ cpu ë‹¨ìœ„ë¡œ ì¸¡ì •ëœë‹¤. ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ CPU 1ê°œëŠ” í´ë¼ìš°ë“œ ê³µê¸‰ì vCPU/Core 1ê°œì™€ ë² ì–´ë©”íƒˆ ì¸í…” í”„ë¡œì„¸ì„œì—ì„œì˜ 1ê°œ [í•˜ì´í¼ìŠ¤ë ˆë“œ](https://www.intel.co.kr/content/www/kr/ko/gaming/resources/hyper-threading.html)ì— í•´ë‹¹í•œë‹¤.
* ë¶„ìˆ˜ ìš”ì²­ì´ í—ˆìš©ëœë‹¤. 0.5 ì˜ `spec.containers[].resources.requests.cpu` ìš”ì²­ì„ ê°€ì§„ ì»¨í…Œì´ë„ˆëŠ” CPU 1ê°œë¥¼ ìš”êµ¬í•˜ëŠ” ì»¨í…Œì´ë„ˆ ì ˆë°˜ë§Œí¼ CPU ë¥¼ ë³´ì¥í•œë‹¤.
  * 0.1 ì´ë¼ëŠ” í‘œí˜„ì€ ë°± ë°€ë¦¬ CPU ë¡œ ì½ì„ ìˆ˜ ìˆëŠ” 100m í‘œí˜„ê³¼ ë™ì¼í•˜ë‹¤.

#### ë©”ëª¨ë¦¬ ì˜ë¯¸
* `memory` ì— ëŒ€í•œ ì œí•œ ë° ìš”ì²­ì€ `ë°”ì´íŠ¸ë‹¨ìœ„` ë¡œ ì¸¡ì •ëœë‹¤.
* E, P, T, G, M, K ì™€ ê°™ì€ ì ‘ë¯¸ì‚¬ ì¤‘ í•˜ë‚˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ë©”ëª¨ë¦¬ë¥¼ ì¼ë°˜ ì •ìˆ˜ ë˜ëŠ” ê³ ì • ì†Œìˆ˜ì  ìˆ«ìë¡œ í‘œí˜„í•  ìˆ˜ ìˆë‹¤.
  * Ei, Pi, Ti, Gi, Mi, Ki ì™€ ê°™ì€ 2ì˜ ê±°ë“­ì œê³±ì„ ì‚¬ìš©í•  ìˆ˜ë„ ìˆë‹¤.

ë‹¤ìŒì€ ë™ì¼í•œ ê°’ì˜ ë©”ëª¨ë¦¬ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.
> 128974848, 129e6, 129M, 123Mi

## ğŸŸ  íŒŒë“œë¥¼ í´ëŸ¬ìŠ¤í„°ì— ë…¸ì¶œ
* ports[].containerPort ë¥¼ ì‚¬ìš©ì„ í•˜ëŠ”ê±¸ë¡œ ë³´ì¸ë‹¤.

## ğŸŸ  ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ ì •ì±…
* íŒŒë“œì˜ `spec` ì—ëŠ” `restartPolicy` í•„ë“œê°€ ìˆë‹¤.
   * ì‚¬ìš©ê°€ëŠ¥í•œ ê°’ì€ `Always`, `OnFailure`, `Never` ì´ê³  ê¸°ë³¸ê°’ì€ `Always` ì´ë‹¤.
   * `restartPolicy` ëŠ” ëª¨ë“  ì»¨í…Œì´ë„ˆì— ì ìš©ëœë‹¤.
   * `restartPolicy` ëŠ” ë™ì¼í•œ ë…¸ë“œì—ì„œ kubelet ì— ì˜í•œ ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ë§Œì„ ì˜ë§ˆí•œë‹¤.
      * íŒŒë“œì˜ ì»¨í…Œì´ë„ˆê°€ ì¢…ë£Œëœ í›„, kubelet ì€ 5ë¶„ìœ¼ë¡œ ì œí•œë˜ëŠ” ì§€ìˆ˜ ë°±ì˜¤í”„ ì§€ì—°(10ì´ˆ, 20ì´ˆ, 40ì´ˆ, ...) ìœ¼ë¡œ ì»¨í…Œì´ë„ˆë¥¼ ì¬ì‹œì‘í•œë‹¤.
      * ì»¨í…Œì´ë„ˆê°€ 10ë¶„ë™ì•ˆ ì•„ë¬´ëŸ° ë¬¸ì œì—†ì´ ì‹¤í–‰ë˜ë©´, kubelet ì€ í•´ë‹¹ ì»¨í…Œì´ë„ˆì˜ ì¬ì‹œì‘ ë°±ì˜¤í”„ íƒ€ì´ë¨¸ë¥¼ ì¬ì„¤ì •í•œë‹¤.

## ğŸŸ  ì»¨í…Œì´ë„ˆê°€ ìš”ì²­ì„ ì²˜ë¦¬í•  ì¤€ë¹„ê°€ ë˜ì—ˆëŠ”ì§€ í™•ì¸ (http prove)
* í”„ë¡œë¸ŒëŠ” ì»¨í…Œì´ë„ˆì—ì„œ kubelet ì— ì˜í•´ ì£¼ê¸°ì ìœ¼ë¡œ ìˆ˜í–‰ë˜ëŠ” ì§„ë‹¨ì´ë‹¤. 
   * ì§„ë‹¨ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ì„œëŠ” kubelet ì€ ì»¨í…Œì´ë„ˆì— ì˜í•´ì„œ êµ¬í˜„ëœ í•¸ë“¤ëŸ¬ë¥¼ í˜¸ì¶œí•œë‹¤. (í•¸ë“¤ëŸ¬ì—ëŠ” `3ê°€ì§€ íƒ€ì…` ì´ ì¡´ì¬í•œë‹¤.)
      * ExecAction
      * TCPSocketAction
      * HTTPGetAction
         * ì§€ì •í•œ í¬íŠ¸ ë° ê²½ë¡œì—ì„œ ì»¨í…Œì´ë„ˆ IP ì£¼ì†Œì— ëŒ€í•œ GET ìš”ì²­ì„ ìˆ˜í–‰í•œë‹¤.
         * ì‘ë‹µì˜ ìƒíƒœ ì½”ë“œê°€ 200 ì´ìƒ 400 ë¯¸ë§Œì´ë©´ ì„±ê³µí•œ ê²ƒìœ¼ë¡œ ê°„ì£¼í•œë‹¤.
* `readinessProve`
   * í”„ë¡œë¸Œê°€ ì„±ê³µí•œ ê²½ìš°ì—ë§Œ íŒŒë“œì— íŠ¸ë˜í”½ ì „ì†¡ì„ ì‹œì‘í•˜ë ¤ëŠ” ê²½ìš° ì´ìš©
   * íŒŒë“œê°€ íŠ¸ë˜í”½ì„ ë°›ì§€ ì•ŠëŠ” ìƒíƒœì—ì„œ ì‹œì‘ë˜ê³  ì´í›„ì— í”„ë¡œë¸Œê°€ ì„±ê³µí•˜ê¸° ì‹œì‘í•œ ì´í›„ì—ë§Œ íŠ¸ë˜í”½ì„ ë°›ëŠ”ë‹¤ëŠ” ê²ƒì„ ëª…ì‹œí•œë‹¤.
   * ë§Œì•½ ì»¨í…Œì´ë„ˆê°€ ëŒ€ëŸ‰ì˜ ë°ì´í„°, ì„¤ì •íŒŒì¼ë“¤ ë˜ëŠ” ì‹œë™ì¤‘ì¸ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì²˜ë¦¬í•´ì•¼ í•œë‹¤ë©´ ì¤€ë¹„ì„± í”„ë¡œë¸Œë¥¼ ì§€ì •í•˜ì—¬ì•¼ í•œë‹¤.
```yaml
readinessProbe:
 failureThreshold: 2    # 2ë²ˆì˜ í”„ë¡œë¸Œ ì‹¤íŒ¨ë¥¼ ì„¤ì •í•œë‹¤. (periodSeconds ê°€ 2ì´ˆë‹ˆê¹ 4ì´ˆë™ì•ˆ í”„ë¡œë¸Œê°€ 2ë²ˆ ì‹¤íŒ¨í•˜ë©´ ë” ì´ìƒì˜ íŠ¸ë˜í”½ì„ ë³´ë‚´ì§€ ì•ŠìŒì„ ë§í•œë‹¤.)
 httpGet:
   path: /health        # http get ê²½ë¡œ
   port: 3000
   scheme: HTTP
 initialDelaySeconds: 2 # ì²«ë²ˆì§¸ í”„ë¡œë¸Œì´ì „ì— ì»¨í…Œì´ë„ˆê°€ ì‘ì„±ëœ í›„ 2ì´ˆë¥¼ ëŒ€ê¸°í•œë‹¤. ì´í›„ periodSeconds ì´ˆ ë§Œí¼ í™•ì¸í•œë‹¤.
 periodSeconds: 2       # 2ì´ˆ ì£¼ê¸°ë¡œ ì§„ë‹¨í•¨ì„ ì˜ë¯¸.
 successThreshold: 1    # ì‹¤íŒ¨ í›„ í”„ë¡œë¸Œê°€ ì„±ê³µí•´ì•¼ í•˜ëŠ” íšŸìˆ˜ë¥¼ ì˜ë¯¸í•œë‹¤.
 timeoutSeconds: 1      # í”„ë¡œë¸Œ ì œí•œì‹œê°„ì„ ì˜ë¯¸í•œë‹¤.
```

### failureThreshold ê°œì¸ì ì¸ ê¶ê¸ˆì¦
probe ê°€ `failureThreshold` ì„¤ì •í•œë§Œí¼ ì‹¤íŒ¨ê°€ ëœë‹¤ë©´ ì´í›„ì—ëŠ” ì–´ë–»ê²Œ ë  ê²ƒì¸ê°€?   
í”„ë¡œë¸Œ ì •ì±…ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆë‹¤.

* `livenessProbe` : í™œì„±í™” í”„ë¡œë¸Œ
   *  ì»¨í…Œì´ë„ˆê°€ ë™ì‘ ì¤‘ì¸ì§€ ì—¬ë¶€ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤. ë§Œì•½ í™œì„±í™” í”„ë¡œë¸Œì— ì‹¤íŒ¨í•œë‹¤ë©´, kubelet ì€ `ì»¨í…Œì´ë„ˆë¥¼ ì£½ì´ê³ `, í•´ë‹¹ ì»¨í…Œì´ë„ˆëŠ” ì¬ì‹œì‘ ì •ì±…ì˜ ëŒ€ìƒì´ ëœë‹¤.
   *  ë§Œì•½ ì»¨í…Œì´ë„ˆê°€ í™œì„±í”„ë¡œë¸Œë¥¼ ì œê³µí•˜ì§€ ì•ŠëŠ” ìƒíƒœë¼ê³  í•œë‹¤ë©´, ê¸°ë³¸ ìƒíƒœëŠ” `Success` ê°€ ëœë‹¤.
* `readinessProbe` : ì¤€ë¹„ì„± í”„ë¡œë¸Œ
   * ì»¨í…Œì´ë„ˆê°€ ìš”ì²­ì„ ì²˜ë¦¬í•  ì¤€ë¹„ê°€ ë˜ì—ˆëŠ”ì§€ ì—¬ë¶€ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.
   * ë§Œì•½ ì¤€ë¹„ì„± í”„ë¡œë¸Œê°€ ì‹¤íŒ¨í•œë‹¤ë©´, ì—”ë“œí¬ì¸íŠ¸ ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” íŒŒë“œì— ì—°ê´€ëœ ëª¨ë“  ì„œë¹„ìŠ¤ë“¤ì˜ ì—”ë“œí¬ì¸íŠ¸ì—ì„œ íŒŒë“œì˜ IP ì£¼ì†Œë¥¼ ì œê±°í•œë‹¤.
   * ì¤€ë¹„ì„± í”„ë¡œë¸Œì˜ ì´ˆê¸°ì§€ì—° ì´ì „ì˜ ê¸°ë³¸ìƒíƒœëŠ” `Failure` ì´ë‹¤.
* `startupProbe` : ìŠ¤íƒ€íŠ¸ì—… í”„ë¡œë¸Œ
   * ì»¨í…Œì´ë„ˆ ë‚´ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì‹œì‘ë˜ì—ˆëŠ”ì§€ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.
   * ìŠ¤íƒ€íŠ¸ì—… í”„ë¡œë¸Œê°€ ì£¼ì–´ì§„ ê²½ìš°, ì„±ê³µí•  ë•Œê¹Œì§€ ë‹¤ë¥¸ ë‚˜ë¨¸ì§€ í”„ë¡œë¸ŒëŠ” í™œì„±í™”ë˜ì§€ ì•ŠëŠ”ë‹¤.
   * ë§Œì•½ ìŠ¤íƒ€íŠ¸ì—… í”„ë¡œë¸Œê°€ ì‹¤íŒ¨í•˜ë©´, kubelet ì´ ì»¨í…Œì´ë„ˆë¥¼ ì£½ì´ê³ , ì»¨í…Œì´ë„ˆëŠ” ì¬ì‹œì‘ ì •ì±…ì— ë”°ë¼ ì²˜ë¦¬ëœë‹¤.

## ğŸŸ  strategy : ì´ì „ íŒŒë“œë¥¼ ìƒˆë¡œìš´ íŒŒë“œë¡œ ëŒ€ì²´í•˜ëŠ” ì „ëµ

deployments yaml ëª…ì„¸
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: helloworld
  name: helloworld
spec:
  replicas: 3
  minReadySeconds: 0
  selector:
    matchLabels:
      app: helloworld
  strategy:
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 1
    type: RollingUpdate
```
* `.spec.strategy` ëŠ” ì´ì „ íŒŒë“œë¥¼ ìƒˆë¡œìš´ íŒŒë“œë¡œ ëŒ€ì²´í•˜ëŠ” ì „ëµì„ ëª…ì„¸í•  ìˆ˜ ìˆë‹¤.
   * `.spec.strategy.type` ì˜ ê°’ì€ `ì¬ìƒì„±` ë˜ëŠ” `ë¡¤ë§ì—…ë°ì´íŠ¸` ê°€ ë  ìˆ˜ ìˆë‹¤.
      * `RollingUpdate` : ìƒˆë¡œìš´ íŒŒë“œê°€ ì ì§„ì ìœ¼ë¡œ ì¶”ê°€ë˜ê³ , ì´ì „ íŒŒë“œëŠ” ì¤‘ì§€ëœë‹¤. (ë””í”Œë¡œì´ë¨¼íŠ¸ì˜ ê¸°ë³¸ì ì¸ ë°°í¬ì „ëµì´ë‹¤.)
      * `Recreate` : ìƒˆë¡œìš´ íŒŒë“œê°€ ì¶”ê°€ë˜ê¸° ì´ì „ì— ì´ì „ íŒŒë“œê°€ í•œë²ˆì— ì¤‘ì§€ëœë‹¤.
   * `ë¡¤ë§ì—…ë°ì´íŠ¸` ê°€ ê¸°ë³¸ê°’ì´ë‹¤.
* `.spec.strategy.rollingUpdate.maxSurge`
   * ì—…ë°ì´íŠ¸ ì¤‘ì—, ë™ì‹œì— ìµœëŒ€ë¡œ ì¶”ê°€í•  ìˆ˜ ìˆëŠ” íŒŒë“œì˜ ìˆ˜ (% ë¡œ ì„¤ì •í•  ì‹œ, ì›í•˜ëŠ” ê°œìˆ˜ì˜ íŒŒë“œì˜ ë¹„ìœ¨ì´ ë°˜ì˜¬ë¦¼ë˜ì–´ ì§€ì •ëœë‹¤.)
* `.spec.strategy.rollingUpdate.maxUnavailable`
   * ì—…ë°ì´íŠ¸ ì¤‘ì—, ë™ì‹œì— ì‚¬ìš©ë¶ˆê°€ëŠ¥í•œ ìƒíƒœê°€ ë  ìˆ˜ ìˆëŠ” íŒŒë“œì˜ ìˆ˜

#### ë¡¤ë§ì—…ë°ì´íŠ¸
> ìƒˆ ë²„ì „ì„ ë°°í¬í•˜ë©´ì„œ, ìƒˆ ë²„ì „ ì¸ìŠ¤í„´ìŠ¤ë¥¼ í•˜ë‚˜ì”© ëŠ˜ë ¤ê°€ê³  ê¸°ì¡´ ë²„ì „ì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ í•˜ë‚˜ì‹ ì¤„ì—¬ë‚˜ê°€ëŠ” ë°©ì‹ì…ë‹ˆë‹¤. ì´ëŸ¬í•œ ê²½ìš° ìƒˆ ë²„ì „ì˜ ì¸ìŠ¤í„´ìŠ¤ë¡œ íŠ¸ë˜í”½ì´ ì´ì „ë˜ê¸° ì „ê¹Œì§€ ì´ì „ ë²„ì „ê³¼ ìƒˆ ë²„ì „ì˜ ì¸ìŠ¤í„´ìŠ¤ê°€ ë™ì‹œì— ì¡´ì¬í•  ìˆ˜ ìˆë‹¤ëŠ” ë‹¨ì ì´ ìˆì§€ë§Œ, ì‹œìŠ¤í…œì„ ë¬´ì¤‘ë‹¨ìœ¼ë¡œ ì—…ë°ì´íŠ¸ í•  ìˆ˜ ìˆë‹¤ëŠ” ì¥ì ì´ ìˆìŠµë‹ˆë‹¤.   
[ì°¸ê³ ](https://ooeunz.tistory.com/124)

## ì„œë¹„ìŠ¤ yaml
```yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    app: helloworld
  name: helloworld
spec:
  ports:
    - name: 8080-8080
      port: 8080
      protocol: TCP
      targetPort: 8080
  selector:
    app: helloworld
  type: ClusterIP
```

## reference
* https://kubernetes.io/ko/docs/concepts/containers/images/
* https://kubernetes.io/ko/docs/concepts/configuration/manage-resources-containers/
* https://www.mirantis.com/blog/introduction-to-yaml-creating-a-kubernetes-deployment/
* [k8s pod ë¥¼ ì§„ë‹¨í•˜ëŠ” ì„œë¹„ìŠ¤](https://medium.com/finda-tech/kubernetes-pod%EC%9D%98-%EC%A7%84%EB%8B%A8%EC%9D%84-%EB%8B%B4%EB%8B%B9%ED%95%98%EB%8A%94-%EC%84%9C%EB%B9%84%EC%8A%A4-probe-7872cec9e568)
* [kubernetes-graceful-shutdown-example](https://github.com/RisingStack/kubernetes-graceful-shutdown-example/blob/master/kubernetes/deployment.yaml)
* [ì¬ì‹œì‘ ì •ì±…](https://kubernetes.io/ko/docs/concepts/workloads/pods/pod-lifecycle/#restart-policy)
