## 가상 면접 사례로 배우는 대규모 시스템 설계 기초
책에서 읽은 내용 일부를 발췌하고 궁금증을 해소한다.

### 1장 사용자 수에 따른 규모 확장성
* 비관계형 데이터베이스가 더 적합한 경우가 존재함
    * 아주 낮은 응답 지연시간(latency) 
        * -> `이해를 못하겠음. 왜 NoSQL 이 그런걸까?` -> _MySQL 에 비해서 조인이 없기 때문에, 그 부분을 돌려 이야기한 것으로 추정_
    * 다루는 데이터가 비정형이라 관계형 데이터가 아님
    * 데이터(json, yaml, xml 등) 을 직렬화 하거나 역직렬화할 수 있기만 하면 됨
    * 아주 많은 양의 데이터를 저장할 필요가 있음
        * -> `수평확장을 하는데 유리하게 설계되었기 때문에 대량의 데이터를 저장하는게 가능`
* 데이터베이스 다중화
    * 데이터베이스는 마스터-슬레이브 구성으로 하여 가용성 및 안정성을 확보한다.
        * 쓰기연산은 마스터 디비, 읽기연산은 슬레이브 디비
        * -> `쓰기 연산은 마스터에서 수행하면 마스터와 슬레이브 간의 데이터 싱크가 실시간으로 이뤄지지 않아, 슬레이브로 읽기 시 데이터 누락이 있을 수 있지 않을까?`
    * 자연재해 등의 이유로 데이터베이스 서버 가운데 일부가 파괴되어도 데이터는 보존될 것이다. 데이터를 지역적으로 떨어진 여러장소에 다중화시켜 놓을 수 있기 때문이다.
        * -> `데이터베이스가 지역적으로 멀면 데이터를 복제하고 동기화 하는데, 네트워크 비용이 올라가지 않을까?`
        * chatGPT 는 데이터베이스 다중화 시 지역간의 데이터 동기화를 위해 주의해야할 점을 이야기 해줌
            * 데이터 압축 : 데이터를 압축하여 네트워크 대역폭을 줄일 수 있다.
            * 비동기식 복제 : 일정간격으로 데이터를 동기화할 수 있다.
            * 지역별 용도 : 지역별로 데이터 동기화 빈도와 용도를 구분해야 한다.
* 캐시 사용 시 유의할 점
    * 데이터 방출(eviction) 정책은 무엇인가?
        * -> `사내 레디스 인프라팀에서 레디스 기본 정책이 있음`
* 수평적 확장
    * 샤딩 키를 정할 떄는 데이터를 고르게 분할 할 수 있도록 하는 게 가장 중요하다. 샤딩은 데이터베이스 규모 확장을 실현하는 훌륭한 기술이지만 완벽하진 않다.

### 4장 처리율 제한 장치의 설계
* 처리율 제한장치의 장점
    * DoS(Denial Of Service) 에 대한 자원고갈을 방지
    * 그 외는 책 참고
* 처리율 제한 알고리즘
    * 토큰 버킷 (token bucket)
    * 누출 버킷 (leaky bucket)
    * 고정 윈도 카운터 (fixed window counter)
    * 이동 윈도 로그 (sliding window log)
    * 이동 윈도 카운터 (sliding window counter)
* 처리율 제한 장치가 사용하는 HTTP 헤더
    * X-Ratelimit-Remaming : 윈도 내에 남은 처리 가능 요청의 수
    * X-Ratelimit-Limit : 매 윈도마다 클라이언트가 전송할 수 있는 요청의 수
    * X-Ratelimit-Retry-After : 한도 제한에 걸리지 않으려면 몇 초 뒤에 요청을 다시 보내야 하는지 알림
* 분산 환경에서의 처리율 제한 장치의 구현
    * `레디스` 를 메인 스토리지로 이용
        * 레디스 이용 시, 경쟁조선이 발생할 수 있음 ex) READ -> CHECK -> INCREMENT
        * 경쟁조건을 해소하기 위해선, 루아 스크립트 또는 Sorted Set 을 이용이 필요
        * 경쟁조건을 피하기 위해 `Sorted Set 을 어떻게 이용하는가?`
* 처리율 제한을 회피하는 바업. 클라이언트를 어떻게 설계하는 것이 최선인가?
    * 클라이언트 측 캐시를 사용하여 API 호출 횟수를 줄인다.
    * 처리율 제한의 임계치를 이해하고, 짧은 시간 동안 너무 많은 메시지를 보내지 않도록 한다.
    * 예외나 에러를 처리하는 코드를 도입하여 클라이언트가 예외적 상황으로 우아하게 복구될 수 있도록 한다.
    * 재시도(retry) 로직을 구현할 때는 충분한 백오프(back-off) 시간을 둔다.
* 참고
    * https://www.ietf.org/archive/id/draft-polli-ratelimit-headers-02.html 
    * https://www.mimul.com/blog/about-rate-limit-algorithm/
